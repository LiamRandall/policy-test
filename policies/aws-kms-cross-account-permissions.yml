vars:

  long-description: &long-description |
      This policy will verify that KMS keys are not granting access to any
      untrusted AWS accounts. Trusted accounts can be whitelisted in the
      policies cross-account filter. Any untrusted cross account permissions
      will be removed from the KMS keys to bring the resource back into
      compliance with this policy and a notification will be sent. If a KMS
      key's policy is too permissive, attackers or untrusted parties could gain
      access to the KMS keys and change the keys access to remove trusted users
      and add untrusted users access to decrypt the data. This policy helps with
      compliance standards such as APRA, MAS, NIST 800-53 rev4 and PCI DSS by
      identifying and remediating the non-compliant KMS keys permissions.

  description: &description |
      KMS keys which have unauthorized cross account permissions will be
      identified, the insecure permissions removed, and impacted users will be
      notified.

  s3-url: &s3-url s3://s3bucket/CompanyAccountNumbers.csv

  violation-desc: &violation-desc |
      KMS keys should not be granting permissions to any unauthorized accounts.
      The identified KMS keys access was overly permissive via the KMS key's
      access policy and the unauthorized permissions have automatically been
      removed.

  action-desc: &action-desc |
      The identified KMS keys unauthorized cross account permissions have been
      removed by Cloud Custodian.

  subject: &subject "KMS Key - Unauthorized Cross Account Access Removed - [custodian {{ account }} - {{ region }}]"

  mailer-queue: &mailer-queue https://sqs.{region}.amazonaws.com/{account}/cloud-custodian-mailer



policies:


####################################################################
#####   AWS.KMS - Unauthorized Cross Account Permissions       #####
####################################################################




#########################
## CloudTrail mode policy
#########################


- name: aws-kms-cross-account-permissions
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Compliance::PCI DSS
    - Risk::High
  resource: kms
  metadata:
    long-description: *long-description
  mode:
      type: cloudtrail
      events:
        - source: kms.amazonaws.com
          event: CreateGrant
          ids: 'requestParameters.keyId'
        - source: kms.amazonaws.com
          event: PutKeyPolicy
          ids: 'requestParameters.keyId'
        - source: kms.amazonaws.com
          event: CreateKey
          ids: 'requestParameters.keyMetadata.keyId'
  description: *description
  filters:
      - type: cross-account
        everyone_only: false
        whitelist_from:
            url: *s3-url
            format: csv2dict
  actions:
      - type: remove-statements
        statement_ids: matched
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        violation_desc: *violation-desc
        action_desc: *action-desc
        owner_absent_contact:
            - "{missingcontact}"
        to:
            - resource-owner
            - event-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}




####################
## Pull mode policy
####################


- name: aws-kms-cross-account-permissions-pull
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Compliance::PCI DSS
    - Risk::High
  resource: kms
  max-resources:
    percent: 10
    amount: 10
    op: and
  metadata:
    long-description: *long-description
  description: *description
  filters:
      - type: cross-account
        everyone_only: false
        whitelist_from:
            url: *s3-url
            format: csv2dict
  actions:
      - type: remove-statements
        statement_ids: matched
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        violation_desc: *violation-desc
        action_desc: *action-desc
        owner_absent_contact:
            - "{missingcontact}"
        to:
            - resource-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}

vars:

  long-description: &long-description |
      This policy will verify that AWS EBS snapshots are encrypted to ensure
      proper data security and compliance standards are being met. Non-encrypted
      EBS snapshots would allow unauthorized users to copy the data and create
      their own copy of the volume using the snapshot. This policy helps with
      compliance standards such as APRA, GDPR, HIPAA, MAS, NIST 800-53 rev4, and
      PCI DSS by identifying the non-compliant EBS volume snapshots which are
      non-encrypted and taking an appropriate action. Remediation options
      include deleting the non-encrypted EBS snapshot or a notification sent to
      the impacted users.

  description: &description |
      Newly created or modified EBS volume snapshots which are not encrypted
      will be identified, deleted, and the impacted users notified.

  subject: &subject |
      "EBS Snapshot - Deleted Due To Missing Encryption - [custodian {{ account }} - {{ region }}]"

  mailer-queue: &mailer-queue https://sqs.{region}.amazonaws.com/{account}/cloud-custodian-mailer




policies:


########################################################################################
#####   AWS.EBS-SNAPSHOT - EBS Volume Snapshots Must Be Encrypted                  #####
########################################################################################




################################
## CloudTrail mode policy chain
################################


- name: aws-ebs-snapshot-encrypted
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::HIPAA
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Compliance::PCI DSS
    - Risk::High
  resource: ebs-snapshot
  metadata:
    long-description: *long-description
  mode:
    type: cloudtrail
    events:
      - source: "ec2.amazonaws.com"
        event: "ModifySnapshotAttribute"
        ids: "requestParameters.snapshotId"
      - source: "ec2.amazonaws.com"
        event: "CreateSnapshot"
        ids: "responseElements.snapshotId"
  description: *description
  filters:
    - "Encrypted": false
  actions:
    - type: delete
      skip-ami-snapshots: true
    - type: notify
      template: default.html
      priority_header: 1
      subject: *subject
      to:
         - event-owner
         - resource-owner
      transport:
           type: sqs
           queue: *mailer-queue
           region: {region}




####################
## Pull mode policy
####################


- name: aws-ebs-snapshot-encrypted-pull
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::HIPAA
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Compliance::PCI DSS
    - Risk::High
  resource: ebs-snapshot
  max-resources:
    percent: 10
    amount: 10
    op: and
  metadata:
    long-description: *long-description
  description: *description
  filters:
    - "Encrypted": false
  actions:
    - type: delete
      skip-ami-snapshots: true
    - type: notify
      template: default.html
      priority_header: 1
      subject: *subject
      to:
         - resource-owner
      transport:
           type: sqs
           queue: *mailer-queue
           region: {region}

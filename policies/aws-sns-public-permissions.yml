vars:

  long-description: &long-description |
      This policy will verify that SNS topics are not granting public/everyone
      permissions. Any public/everyone permissions will be removed from the SNS
      topics to bring the resource back into compliance with this policy and a
      notification will be sent. A SNS topic's access policy should not be
      unduly permissive and should use least privileged access model as
      attackers or untrusted parties could gain access to the topics messages or
      settings and a data leak or service abuse could occur. This policy helps
      with compliance standards such as APRA, GDPR, MAS, NIST 800-53 rev4 and
      PCI DSS by identifying and remediating the non-compliant public SNS
      topics.

  description: &description |
      SNS topics which have unauthorized public permissions will be identified,
      the insecure public permissions removed, and the impacted users will be
      notified.

  violation-desc: &violation-desc |
      SNS topics should not be granting permissions to any unauthorized
      accounts. The identified SNS topic's access was overly permissive via the
      SNS topic's access policy and the unauthorized permissions have
      automatically been removed.

  action-desc: &action-desc |
      The identified SNS topics unauthorized cross account access has been
      removed by Cloud Custodian.

  subject: &subject "SNS Topic - Unauthorized Public/Cross Account Access Removed - [custodian {{ account }} - {{ region }}]"

  mailer-queue: &mailer-queue https://sqs.{region}.amazonaws.com/{account}/cloud-custodian-mailer



policies:


###########################################################################
#####   AWS.SNS - Unauthorized Public Cross Account Permissions       #####
###########################################################################




#########################
## CloudTrail mode policy
#########################


- name: aws-sns-public-permissions
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Compliance::PCI DSS
    - Risk::High
  resource: sns
  metadata:
    long-description: *long-description
  mode:
      type: cloudtrail
      events:
        - source: sns.amazonaws.com
          event: CreateTopic
          ids: 'responseElements.topicArn'
        - source: sns.amazonaws.com
          event: SetTopicAttributes
          ids: 'requestParameters.topicArn'
        - source: sns.amazonaws.com
          event: AddPermission
          ids: 'requestParameters.topicArn'
  description: *description
  filters:
      - type: cross-account
        everyone_only: true
  actions:
      - type: remove-statements
        statement_ids: matched
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        violation_desc: *violation-desc
        action_desc: *action-desc
        owner_absent_contact:
            - "{missingcontact}"
        to:
            - resource-owner
            - event-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}




####################
## Pull mode policy
####################


- name: aws-sns-public-permissions-pull
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Compliance::PCI DSS
    - Risk::High
  resource: sns
  max-resources:
    percent: 10
    amount: 10
    op: and
  metadata:
    long-description: *long-description
  description: *description
  filters:
      - type: cross-account
        everyone_only: true
  actions:
      - type: remove-statements
        statement_ids: matched
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        violation_desc: *violation-desc
        action_desc: *action-desc
        owner_absent_contact:
            - "{missingcontact}"
        to:
            - resource-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}

vars:

  long-description: &long-description |
      This policy will ensure EBS volumes are encrypted so that information on
      them can be securely stored and accessed. AWS EBS volumes should be
      encrypted to protect from attackers, malicious activity, and unauthorized
      users. This policy helps with compliance standards such as APRA, GDPR, HIPAA,
      MAS, NIST and PCI-DSS by identifying the non-compliant EBS volumes.

  description: &description |
      EBS volumes which are not encrypted will be identified, encrypted, and the
      impacted users will be notified.

  kms-key-alias: &kms-key-alias alias/Company-Standardized-EBS-CMK

  violation-desc: &violation-desc |
      EBS volumes should be encrypted. The identified volumes had
      encryption disabled which does not meet compliance standards.

  action-desc: &action-desc |
      The identified EBS volumes have been updated to be encrypted. Please
      verify your volumes functionality, as the enabling of encryption or
      switching of encryption keys can affect some client's connectivity.

  subject: &subject "EBS Volume - Encryption Has Been Enabled - [custodian {{ account }} - {{ region }}]"

  mailer-queue: &mailer-queue https://sqs.{region}.amazonaws.com/{account}/cloud-custodian-mailer




policies:


##########################################################################
#####   AWS.EBS - Not Encrypted   #####
##########################################################################




#########################
## CloudTrail mode policy
#########################


- name: aws-ebs-not-encrypted
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::HIPAA
    - Compliance::MAS
    - Compliance::NIST
    - Compliance::PCI-DSS
    - Risk::High
  metadata:
    long-description: *long-description
  resource: ebs
  mode:
    type: cloudtrail
    events:
      - source: ec2.amazonaws.com
        event: AttachVolume
        ids: 'responseElements.volumeId'
      - source: ec2.amazonaws.com
        event: CreateVolume
        ids: 'responseElements.volumeId'
  description: *description
  filters:
    - type: value
      key: "Attachments[0].Device"
      value: not-null
    - or:
       - "KmsKeyId": absent
       - "Encrypted": false
  actions:
    - type: encrypt-instance-volumes
      key: *kms-key-alias
    - type: notify
      template: default.html
      priority_header: 1
      subject: *subject
      violation_desc: *violation-desc
      action_desc: *action-desc
      owner_absent_contact:
          - "{missingcontact}"
      to:
          - resource-owner
          - event-owner
      transport:
          type: sqs
          queue: *mailer-queue
          region: {region}




####################
## Pull mode policy
####################


- name: aws-ebs-not-encrypted-pull
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::HIPAA
    - Compliance::MAS
    - Compliance::NIST
    - Compliance::PCI-DSS
    - Risk::High
  metadata:
    long-description: *long-description
  resource: ebs
  max-resources:
    percent: 10
    amount: 10
    op: and
  description: *description
  filters:
   - type: value
     key: "Attachments[0].Device"
     value: not-null
   - or:
      - "KmsKeyId": absent
      - "Encrypted": false
  actions:
   - type: encrypt-instance-volumes
     key: *kms-key-alias
   - type: notify
     template: default.html
     priority_header: 1
     subject: *subject
     violation_desc: *violation-desc
     action_desc: *action-desc
     owner_absent_contact:
         - "{missingcontact}"
     to:
         - resource-owner
     transport:
         type: sqs
         queue: *mailer-queue
         region: {region}

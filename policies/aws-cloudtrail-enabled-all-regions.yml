vars:

  long-description: &long-description |
      Enabling global monitoring for your existing trails will help you to
      better manage your AWS account and maintain the security of your
      infrastructure. Applying your trail to all AWS regions has multiple
      advantages, such as receiving and storing log files from all regions in a
      single S3 bucket and a single CloudWatch Logs group. It also enables
      managing trail configuration for all regions from one location and
      recording of API calls in regions that are not used to detect any
      anomalous activity.

  description: &description |
      This policy ensures that AWS CloudTrail is enabled for all regions in
      order to increase the visibility of the API activity in your AWS account
      for security and management purposes.

  violation-desc: &violation-desc |
      AWS CloudTrail is not enabled in all regions, which limits your ability to
      monitor API calls in your environment, putting you at risk, from a
      security and management perspective.

  action-desc: &action-desc |
      The identified AWS CloudTrail was not configured to run in every region
      and has been configured by Cloud Custodian so that every region is now
      recorded.

  subject: &subject "AWS CloudTrail - Global Region Recording Is Now Enabled - [custodian {{ account }} - {{ region }}]"

  mailer-queue: &mailer-queue https://sqs.{region}.amazonaws.com/{account}/cloud-custodian-mailer



policies:


##########################################################################
#####   AWS.CLOUDTRAIL ENABLED ALL REGIONS                           #####
##########################################################################




################################
## CloudTrail mode policy     ##
################################


- name: aws-cloudtrail-enabled-all-regions
  tags:
    - Category::Security
    - Compliance::CIS Security AWS Foundations Benchmark
    - Compliance::PCI-DSS
    - Compliance::HIPAA
    - Compliance::GDPR
    - Compliance::APRA
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Risk::High
  metadata:
      long-description: *long-description
  resource: cloudtrail
  mode:
    type: cloudtrail
    events:
        - source: cloudtrail.amazonaws.com
          event: CreateTrail
          ids: "responseElements.trailARN"
        - source: cloudtrail.amazonaws.com
          event: UpdateTrail
          ids: "responseElements.trailARN"
  description: *description
  filters:
    - "IsMultiRegionTrail": false
  actions:
      - type: update-trail
        attributes:
          IsMultiRegionTrail: true
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        violation_desc: *violation-desc
        action_desc: *action-desc
        to:
            - resource-owner
            - event-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}



######################
## Pull mode policy ##
######################


- name: aws-cloudtrail-enabled-all-regions-pull
  tags:
    - Category::Security
    - Compliance::PCI-DSS
    - Compliance::HIPAA
    - Compliance::GDPR
    - Compliance::APRA
    - Compliance::MAS
    - Compliance::NIST 800-53 (Rev 4)
    - Risk::High
  resource: cloudtrail
  metadata:
      long-description: *long-description
  filters:
    - "IsMultiRegionTrail": false
  actions:
      - type: update-trail
        attributes:
          IsMultiRegionTrail: true
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        violation_desc: *violation-desc
        action_desc: *action-desc
        to:
            - resource-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}

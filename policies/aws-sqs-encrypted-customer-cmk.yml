vars:

  long-description: &long-description |
      The long description text goes here

  description: &description |
      Short description text goes here

  violation-desc: &violation-desc |
      Violation description text goes here

  action-desc: &action-desc |
      Actions taken description text goes here

  subject: &subject "SQS Queue - Encryption Has Been Enabled/Updated - [custodian {{ account }} - {{ region }}]"

  mailer-queue: &mailer-queue https://sqs.{region}.amazonaws.com/{account}/cloud-custodian-mailer




policies:


##########################################################################
#####   AWS.SQS - Not Encrypted With Customer Managed CMK KMS  Key   #####
##########################################################################




#########################
## CloudTrail mode policy
#########################


- name: aws-sqs-not-encrypted-with-customer-cmk
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Risk::High
  metadata:
    long-description: *long-description
  resource: sqs
  mode:
      type: cloudtrail
      events:
        - source: sqs.amazonaws.com
          event: CreateQueue
          ids: 'responseElements.queueUrl'
        - source: sqs.amazonaws.com
          event: SetQueueAttributes
          ids: 'requestParameters.queueUrl'
  description: *description
  filters:
   - or:
      - "KmsMasterKeyId": absent
      - type: kms-key
        key: c7n:AliasName
        value: ^alias\/aws\/.+
        op: regex
  actions:
      - type: set-encryption
        key: alias/Company-Standardized-SQS-CMK
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        violation_desc: *violation-desc
        action_desc: *action-desc
        owner_absent_contact:
            - "{missingcontact}"
        to:
            - resource-owner
            - event-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}




####################
## Pull mode policy
####################


- name: aws-sqs-not-encrypted-with-customer-cmk-pull
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Risk::High
  metadata:
    long-description: *long-description
  resource: sqs
  max-resources:
    percent: 10
    amount: 10
    op: and
  description: *description
  filters:
   - or:
      - "KmsMasterKeyId": absent
      - type: kms-key
        key: c7n:AliasName
        value: ^alias\/aws\/.+
        op: regex
  actions:
      - type: set-encryption
        key: alias/Company-Standardized-SQS-CMK
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        violation_desc: *violation-desc
        action_desc: *action-desc
        owner_absent_contact:
            - "{missingcontact}"
        to:
            - resource-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}

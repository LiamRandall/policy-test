vars:

  long-description: &long-description |
      This policy will verify that SNS topics are using encryption so that
      sensitive data is secure at rest. Many regulatory and compliance standards
      require data encryption to be enabled across resources. If any SNS topics
      are found without encryption, the default server side encryption will be
      enabled and a notification sent. This policy helps with compliance
      standards such as APRA, GDPR, HIPAA, MAS, NIST 800-53 rev4 and PCI DSS by
      identifying and remediating the non-compliant sns topics.

  description: &description |
      SNS topics which are not utilizing Server Side Encryption (SSE) will be
      identified, modified to use the aws/sns KMS key, and the impacted users
      will be notified.

  violation-desc: &violation-desc |
      SNS topics should be using Server Side Encryption (SSE) for secure data at
      rest. The identified SNS topics were not using SSE and have now been modified
      to utilize SSE with the aws/sns KMS key.

  action-desc: &action-desc |
      The identified SNS topics are now being encrypted with the default aws/sns KMS
      key. Please ensure your SNS topics still function properly as any
      interactions with encrypted SNS topics will require the client to have KMS
      Decrypt permissions.

  subject: &subject "SNS Topic - Encryption Has Been Enabled - [custodian {{ account }} - {{ region }}]"

  mailer-queue: &mailer-queue https://sqs.{region}.amazonaws.com/{account}/cloud-custodian-mailer





policies:


####################################################################
#####   AWS.SNS - Enable SSE Topic Encryption                  #####
####################################################################




#########################
## CloudTrail mode policy
#########################


- name: aws-sns-enable-encryption
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::HIPAA
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Compliance::PCI DSS
    - Risk::High
  resource: sns
  metadata:
    long-description: *long-description
  mode:
      type: cloudtrail
      events:
        - source: sns.amazonaws.com
          event: CreateTopic
          ids: 'responseElements.topicArn'
        - source: sns.amazonaws.com
          event: SetTopicAttributes
          ids: 'requestParameters.topicArn'
  description: *description
  filters:
      - KmsMasterKeyId: absent
  actions:
      - type: set-encryption
        key: "aws/sns"
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        violation_desc: *violation-desc
        action_desc: *action-desc
        owner_absent_contact:
            - "{missingcontact}"
        to:
            - resource-owner
            - event-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}




####################
## Pull mode policy
####################


- name: aws-sns-enable-encryption-pull
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::HIPAA
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Compliance::PCI DSS
    - Risk::High
  resource: sns
  max-resources:
    percent: 10
    amount: 10
    op: and
  metadata:
    long-description: *long-description
  description: *description
  filters:
      - KmsMasterKeyId: absent
  actions:
      - type: set-encryption
        key: "aws/sns"
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        violation_desc: *violation-desc
        action_desc: *action-desc
        owner_absent_contact:
            - "{missingcontact}"
        to:
            - resource-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}

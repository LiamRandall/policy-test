vars:

  long-description: &long-description |
      These policies will check to verify the presence and proper configuration
      of each AWS account's IAM identity providers (IDPs). Ensuring there is a
      properly configured and approved IDP present in each account allows users
      and applications to obtain temporary credentials using their internally
      managed identity which provides a more secure credential method than
      hardcoded IAM access keys and passwords. Using an IDP for cloud
      authentication also allows for an easy and secure way to externally manage
      user access to cloud resources. This policy helps with compliance
      standards such as APRA, MAS, NIST 800-53 rev4 by identifying the accounts
      which are either missing or have an incorrectly configured IDP.

  description: &description |
      Any account which is either missing or has a invalid configured AWS IAM
      IDP will be identified, and the impacted users notified.

  idp-name: &idp-name Company-IDP-Name

  idp-location: &idp-location Company-IDP-Location

  saml-metadata: &saml-metadata Company-SAML-Metadata

  violation-desc: &violation-desc |
      The identified AWS accounts are missing or have an incorrectly configured
      AWS IAM Identity Provider (IDP).

  action-desc: &action-desc |
      Please setup an IDP in the identified account with the proper
      configuration to match company standards.

  subject: &subject "IAM Identity Provider - Missing Or Misconfigured! [custodian {{ account }} - {{ region }}]"

  mailer-queue: &mailer-queue https://sqs.{region}.amazonaws.com/{account}/cloud-custodian-mailer




policies:




####################
## Pull mode policy
####################


- name: aws-account-missing-iam-idp-pull
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::NIST
    - Compliance::MAS
    - Risk::High
  metadata:
    long-description: *long-description
  description: *description
  resource: account
  filters:
    - type: missing
      policy:
         resource: iam-saml-provider
         filters:
               - type: value
                 key: Arn
                 op: contains
                 value: *idp-name
               - type: value
                 key: "IDPSSODescriptor.SingleSignOnService[0].Location"
                 op: contains
                 value: *idp-location
               - type: value
                 key: "SAMLMetadataDocument"
                 op: contains
                 value: *saml-metadata
  actions:
    - type: notify
      template: default.html
      priority_header: 1
      subject: *subject
      violation_desc: *violation-desc
      action_desc: *action-desc
      to:
        - resource-owner
      transport:
          type: sqs
          queue: *mailer-queue
          region: {region}





- name: aws-iam-saml-provider-non-standard-configurations-pull
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::NIST
    - Compliance::MAS
    - Risk::High
  metadata:
    long-description: *long-description
  resource: iam-saml-provider
  description: *description
  filters:
    - not:
      - type: value
        key: Arn
        op: contains
        value: *idp-name
      - type: value
        key: "IDPSSODescriptor.SingleSignOnService[0].Location"
        op: contains
        value: *idp-location
      - type: value
        key: "SAMLMetadataDocument"
        op: contains
        value: *saml-metadata
  actions:
    - type: notify
      template: default.html
      priority_header: 1
      subject: *subject
      violation_desc: *violation-desc
      action_desc: *action-desc
      to:
        - resource-owner
      transport:
          type: sqs
          queue: *mailer-queue
          region: {region}

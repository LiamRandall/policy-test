vars:

  long-description: &long-description |
      This policy will ensure that EFS file systems are encrypted to protect
      your data at rest. AWS EFS file systems should be encrypted to protect
      from attackers, malicious activity, and unauthorized users. This policy
      helps with compliance standards such as APRA, GDPR, HIPAA, MAS and NIST by
      identifying non-compliant EFS file systems.

  description-delete: &description-delete |
      Newly created EFS file systems which are not encrypted at rest will be
      identified, deleted and the impacted users will be notified.

  description-notify: &description-notify |
      Pre-existing EFS file systems which are not encrypted at rest will be
      identified, and the impacted users will be notified.

  violation-desc: &violation-desc |
      EFS file systems should be encrypted at rest. The identified file systems
      had encryption disabled which does not meet compliance standards.

  action-desc-delete: &action-desc-delete |
      The identified, newly created EFS file systems have been deleted, as they
      didn't meet compliance standards. Please recreate the EFS file systems
      with at rest encryption enabled.

  action-desc-notify: &action-desc-notify |
      The identified EFS file systems are not encrypted at rest. Please remove
      the non-encrypted file system and create a new EFS file system with at
      rest encryption enabled.

  subject-delete: &subject-delete "EFS File System - Non-Encrypted File System Has Been Deleted - [custodian {{ account }} - {{ region }}]"

  subject-notify: &subject-notify "EFS File System - At Rest Encryption Not Enabled - [custodian {{ account }} - {{ region }}]"

  mailer-queue: &mailer-queue https://sqs.{region}.amazonaws.com/{account}/cloud-custodian-mailer




policies:


##########################################################################
#####   AWS.EFS - Not Encrypted At Rest   #####
##########################################################################




#########################
## CloudTrail mode policy
#########################


- name: aws-efs-not-encrypted-at-rest
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::HIPAA
    - Compliance::MAS
    - Compliance::NIST
    - Risk::High
  metadata:
    long-description: *long-description
  resource: efs
  mode:
      type: cloudtrail
      events:
        - source: efs.amazonaws.com
          event: CreateFileSystem
          ids: 'responseElements.fileSystemId'
  description: *description-delete
  filters:
    - "Encrypted": false
  actions:
    - type: delete
    - type: notify
      template: default.html
      priority_header: 1
      subject: *subject-delete
      violation_desc: *violation-desc
      action_desc: *action-desc-delete
      owner_absent_contact:
        - "{missingcontact}"
      to:
        - resource-owner
        - event-owner
      transport:
        type: sqs
        queue: *mailer-queue
        region: {region}




####################
## Pull mode policy
####################


- name: aws-efs-not-encrypted-at-rest-pull
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::HIPAA
    - Compliance::MAS
    - Compliance::NIST
    - Risk::High
  metadata:
    long-description: *long-description
  resource: efs
  description: *description-notify
  filters:
    - "Encrypted": false
  actions:
    - type: notify
      template: default.html
      priority_header: 1
      subject: *subject-notify
      violation_desc: *violation-desc
      action_desc: *action-desc-notify
      owner_absent_contact:
        - "{missingcontact}"
      to:
        - resource-owner
        - event-owner
      transport:
        type: sqs
        queue: *mailer-queue
        region: {region}

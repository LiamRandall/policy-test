vars:


  long-description: &long-description |
      This policy will identify root users which have a virtual MFA device. Per
      security best practices, hardware MFA devices should be used instead of
      virtual MFA devices as hardware MFA devices are more secure and much
      harder for attackers to compromise. This policy should be used in
      conjunction with the IAM MFA policy to both ensure an MFA is being used
      and the MFA is a not a virtual device.


  description: &description |
      IAM root users should only be using a hardware MFA token. Any root users
      with virtual MFA devices will be identified and the impacted users
      notified.

  subject: &subject "IAM Root User - MFA Is Not A Hardware Device! [custodian {{ account }} - {{ region }}]"

  violation-desc: &violation-desc |
      IAM root users should not be using virtual MFA devices, instead, a
      hardware MFA should be used as they are more secure than virtual MFA
      devices.

  action-desc: &action-desc |
      Please go into the AWS IAM console and remove the virtual MFA device for the root user and then register a hardware MFA device in its place.


  mailer-queue: &mailer-queue https://sqs.{region}.amazonaws.com/{account}/cloud-custodian-mailer




policies:

####################################################################
#####   AWS.IAM-USER - Root User Virtual MFA Not Allowed       #####
####################################################################



#########################
## CloudTrail mode policy
#########################


- name: aws-iam-root-only-hardware-mfa
  metadata:
      long-description: *long-description
  resource: iam-user
  description: *description
  region: us-east-1
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::CIS 1.6
    - Compliance::GDPR
    - Compliance::MAS
    - Compliance::NIST
    - Risk::High
  mode:
     type: cloudtrail
     events:
        - source: iam.amazonaws.com
          event: CreateVirtualMFADevice
          ids: "responseElements.user.userName"
  filters:
    - type: mfa-device
      key: UserName
      value: not-null
    - type: credential
      key: user
      value: <root_account>
    - or:
       - type: value
         key: "MFADevices[0].SerialNumber"
         op: regex
         value: ^(arn:aws:iam::\d{12}:sms-mfa?)\w+
       - type: value
         key: "MFADevices[1].SerialNumber"
         op: regex
         value: ^(arn:aws:iam::\d{12}:sms-mfa?)\w+
       - type: value
         key: "MFADevices[2].SerialNumber"
         op: regex
         value: ^(arn:aws:iam::\d{12}:sms-mfa?)\w+
       - type: value
         key: "MFADevices[0].SerialNumber"
         op: regex
         value: ^(arn:aws:iam::\d{12}:mfa?)\w+
       - type: value
         key: "MFADevices[1].SerialNumber"
         op: regex
         value: ^(arn:aws:iam::\d{12}:mfa?)\w+
       - type: value
         key: "MFADevices[2].SerialNumber"
         op: regex
         value: ^(arn:aws:iam::\d{12}:mfa?)\w+
  actions:
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        violation_desc: *violation-desc
        action_desc: *action-desc
        to:
            - event-owner
            - resource-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}



####################
## Pull mode policy
####################


- name: aws-iam-root-only-hardware-mfa-pull
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::CIS 1.6
    - Compliance::GDPR
    - Compliance::MAS
    - Compliance::NIST
    - Risk::High
  metadata:
    long-description: *long-description
  resource: iam-user
  region: us-east-1
  description: *description
  filters:
    - type: mfa-device
      key: UserName
      value: not-null
    - type: credential
      key: user
      value: <root_account>
    - or:
       - type: value
         key: "MFADevices[0].SerialNumber"
         op: regex
         value: ^(arn:aws:iam::\d{12}:sms-mfa?)\w+
       - type: value
         key: "MFADevices[1].SerialNumber"
         op: regex
         value: ^(arn:aws:iam::\d{12}:sms-mfa?)\w+
       - type: value
         key: "MFADevices[2].SerialNumber"
         op: regex
         value: ^(arn:aws:iam::\d{12}:sms-mfa?)\w+
       - type: value
         key: "MFADevices[0].SerialNumber"
         op: regex
         value: ^(arn:aws:iam::\d{12}:mfa?)\w+
       - type: value
         key: "MFADevices[1].SerialNumber"
         op: regex
         value: ^(arn:aws:iam::\d{12}:mfa?)\w+
       - type: value
         key: "MFADevices[2].SerialNumber"
         op: regex
         value: ^(arn:aws:iam::\d{12}:mfa?)\w+
  actions:
    - type: notify
      template: default.html
      priority_header: 1
      subject: *subject
      violation_desc: *violation-desc
      action_desc: *action-desc
      to:
        - resource-owner
      transport:
          type: sqs
          queue: *mailer-queue
          region: {region}

vars:

  long-description: &long-description |
      This policy will verify that AWS EBS snapshots are not public facing to
      ensure proper data security and compliance standards are being met.
      Publicly accessible EBS snapshots would allow any unauthorized user to
      copy the data and create their own copy of the volume using the snapshot.
      This policy helps with compliance standards such as APRA, GDPR, MAS, NIST
      800-53 rev4, and PCI DSS by identifying the non-compliant EBS volume
      snapshots which are public facing and taking an appropriate action.
      Remediation options include deleting the public EBS snapshot or a
      notification sent to the impacted users.

  description: &description |
      Newly created or modified EBS volume snapshots which are public facing
      will be identified, deleted, and the impacted users notified.

  description-notify: &description-notify |
      Existing EBS volume snapshots which are public facing will be identified,
      and the impacted users notified.

  subject: &subject "EBS Snapshot - Deleted Due To Public Permissions - [custodian {{ account }} - {{ region }}]"

  subject-notify: &subject-notify "EBS Snapshot - Public Permissions Need Removed - [custodian {{ account }} - {{ region }}]"

  mailer-queue: &mailer-queue https://sqs.{region}.amazonaws.com/{account}/cloud-custodian-mailer




policies:


########################################################################################
#####   AWS.EBS-SNAPSHOT - EBS Volume Snapshots Must Not Be Publicly Accessible        #####
########################################################################################




################################
## CloudTrail mode policy chain
################################


- name: aws-ebs-snapshot-public-permissions
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Compliance::PCI DSS
    - Risk::High
  resource: ebs-snapshot
  metadata:
    long-description: *long-description
  mode:
    type: cloudtrail
    events:
      - source: "ec2.amazonaws.com"
        event: "ModifySnapshotAttribute"
        ids: "requestParameters.snapshotId"
  description: *description
  filters:
    - type: cross-account
      whitelist_orgids:
        - "org-xyz"
  actions:
    - type: delete
      skip-ami-snapshots: true
    - type: notify
      template: default.html
      priority_header: 1
      subject: *subject
      to:
         - resource-owner
         - event-owner
      transport:
           type: sqs
           queue: *mailer-queue
           region: {region}




####################
## Pull mode policy
####################


- name: aws-ebs-snapshot-public-permissions-pull
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Compliance::PCI DSS
    - Risk::High
  resource: ebs-snapshot
  metadata:
    long-description: *long-description
  description: *description-notify
  filters:
    - type: cross-account
      whitelist_orgids:
        - "org-xyz"
  actions:
    - type: notify
      template: default.html
      priority_header: 1
      subject: *subject-notify
      to:
         - resource-owner
      transport:
           type: sqs
           queue: *mailer-queue
           region: {region}

vars:

  long-description: &long-description |
      This policy will ensure that your SSL/TLS certificates managed by AWS ACM
      are renewed 7 days before the expire. AWS Certificate Manager (ACM) is the
      service that lets you easily provision, manage, and deploy SSL/TLS
      certificates for use with other AWS resources such as Elastic Load
      Balancers, CloudFront distributions or APIs on Amazon API Gateway.

  description: &description |
      This policy will ensure that your SSL/TLS certificates managed by AWS ACM
      are renewed 7 days before the expire.

  violation-desc: &violation-desc |
      The identified ACM certificate is 7 days away from expiring and should be
      renewed. SSL/TLS certificates should be renewed before they reach their
      expiration date to prevent disruptions to the secure communications
      between the client and the AWS resource that implements the certificates,
      like CloudFront distributions.

  action-desc: &action-desc |
      The identified AWS Certificate Manager SSL/TLS certificate is due to
      expire in 7 days if not renewed. Certificates that are nearing their
      expiration date will be identified, and a notification sent to the
      impacted users.

  subject: &subject "AWS Certificate Manager Certificate Expires In 7 Days - [custodian {{ account }} - {{ region }}]"

  mailer-queue: &mailer-queue https://sqs.{region}.amazonaws.com/{account}/cloud-custodian-mailer



policies:



####################################################################
#####   AWS.ACM EXPIRING CERTS - 7 DAYS WARNING
####################################################################




#########################
## Pull mode policy
#########################


- name: aws-acm-certificate-notify-on-expiring-7-days
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::MAS
    - Compliance::PCI DSS
    - Risk::High
  resource: acm-certificate
  metadata:
      long-description: *long-description
  filters:
          - type: value
            key: "NotAfter"
            value_type: expiration
            op: gt
            value: 6
          - type: value
            key: "NotAfter"
            value_type: expiration
            op: lt
            value: 8
          - "RenewalEligibility": "INELIGIBLE"
  actions:
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        violation_desc: *violation-desc
        action_desc: *action-desc
        to:
            - resource-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}

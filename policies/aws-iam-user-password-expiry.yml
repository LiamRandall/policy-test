vars:

  long-description: &long-description |
      This policy ensures AWS Identity and Access Management (IAM) user
      passwords are reset according to best practices. Best practices recommend
      that user passwords expire after 90 days or less. Limiting the password
      lifetime increases the user accounts resiliency against brute force login
      attempts. It also helps in scenarios where a password is stolen or
      compromised without your knowledge. This policy helps with compliance
      standards such as GDPR, APRA, MAS, and NIST 800-53 rev4 by identifying the
      non-compliant IAM user passwords.

  description-83: &description-83 |
      This Policy checks the password age for AWS Identity and Access Management
      (IAM) user passwords and if the age is 83 days old it will send a warning
      notification to the impacted users.

  description-60: &description-60 |
     This Policy checks the password age for AWS Identity and Access Management
     (IAM) user passwords and if the age is 60 days old it will send a warning
     notification to the impacted users.

  description-45: &description-45 |
     This Policy checks the password age for AWS Identity and Access Management
     (IAM) user passwords and if the age is 45 days old it will send a warning
     notification to the impacted users.

  action-desc-83: &action-desc-83 |
      The identified IAM user has a password that is 83 days old. In order to
      remain compliant with best practices this password will need to be changed
      prior to reaching 90 days old. Consider changing it before reaching
      password expiry.

  action-desc-60: &action-desc-60 |
      The identified IAM user has a password that is 60 days old. In order to
      remain compliant with best practices this password will need to be changed
      prior to reaching 90 days old. Consider changing it before reaching
      password expiry.

  action-desc-45: &action-desc-45 |
      The identified IAM user has a password that is 45 days old. In order to
      remain compliant with best practices this password will need to be changed
      prior to reaching 90 days old. Consider changing it before reaching
      password expiry.

  subject-83: &subject-83 "AWS IAM User Password Age - An IAM User
      Password Has Reached 83 Days Old - [custodian {{ account }} - {{ region
      }}]"

  subject-60: &subject-60 "AWS IAM User Password Age - An IAM User
      Password Has Reached 60 Days Old - [custodian {{ account }} - {{ region
      }}]"

  subject-45: &subject-45 "AWS IAM User Password Age - An IAM User
      Password Has Reached 45 Days Old - [custodian {{ account }} - {{ region
      }}]"


  mailer-queue: &mailer-queue https://sqs.{region}.amazonaws.com/{account}/cloud-custodian-mailer


policies:


##########################################################################
#####   AWS.IAM-USER - IAM USER PASSWORD IS 83 DAYS OLD              #####
##########################################################################


####################
## Pull mode policy
####################


- name: aws-iam-user-password-expiry-83-days
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::NIST
    - Compliance::MAS
    - Risk::High
  metadata:
    long-description: *long-description
  resource: iam-user
  description: *description-83
  filters:
    - type: credential
      key: password_last_changed
      value_type: age
      value: 82
      op: greater-than
    - type: credential
      key: password_last_changed
      value_type: age
      value: 84
      op: less-than
  actions:
    - type: notify
      template: default.html
      priority_header: 1
      subject: *subject-83
      action_desc: *action-desc-83
      to:
          - resource-owner
      transport:
            type: sqs
            queue: *mailer-queue
            region: {region}


##########################################################################
#####   AWS.IAM-USER - IAM USER PASSWORD IS 60 DAYS OLD              #####
##########################################################################


####################
## Pull mode policy
####################


- name: aws-iam-user-password-expiry-60-days
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::NIST
    - Compliance::MAS
    - Risk::Medium
  metadata:
    long-description: *long-description
  resource: iam-user
  description: *description-60
  filters:
    - type: credential
      key: password_last_changed
      value_type: age
      value: 59
      op: greater-than
    - type: credential
      key: password_last_changed
      value_type: age
      value: 61
      op: less-than
  actions:
    - type: notify
      template: default.html
      priority_header: 2
      subject: *subject-60
      action_desc: *action-desc-60
      to:
          - resource-owner
      transport:
            type: sqs
            queue: *mailer-queue
            region: {region}

##########################################################################
#####   AWS.IAM-USER - IAM USER PASSWORD IS 45 DAYS OLD              #####
##########################################################################


####################
## Pull mode policy
####################


- name: aws-iam-user-password-expiry-45-days
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::NIST
    - Compliance::MAS
    - Risk::Low
  metadata:
    long-description: *long-description
  resource: iam-user
  description: *description-45
  filters:
    - type: credential
      key: password_last_changed
      value_type: age
      value: 44
      op: greater-than
    - type: credential
      key: password_last_changed
      value_type: age
      value: 46
      op: less-than
  actions:
    - type: notify
      template: default.html
      priority_header: 2
      subject: *subject-45
      action_desc: *action-desc-45
      to:
          - resource-owner
      transport:
            type: sqs
            queue: *mailer-queue
            region: {region}

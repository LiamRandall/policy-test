vars:

  long-description: &long-description |
      This policy will verify that CloudTrail log files are recording both
      regional and global events to increase the visibility of the accounts API
      activity. If any CloudTrail logs are found which are not recording global
      events, the CloudTrail logs will be updated to enable global event
      recording and a notification sent. This policy helps with compliance
      standards such as APRA, GDPR, MAS, NIST 800-53 rev4 and PCI DSS by
      identifying and remediating the non-compliant CloudTrail logs.

  description: &description |
      CloudTrail logs which are not recording global events will be
      identified, modified to record global events, and the impacted users
      will be notified.

  violation-desc: &violation-desc |
      CloudTrail logs should always be recording global events in order to
      increase visibility of API activity throughout the account. The identified
      CloudTrail logs were not recording global API events and have now been
      updated so that the CloudTrail logs are now compliant with global recording.

  action-desc: &action-desc |
      The identified CloudTrail logs have been updated by Cloud Custodian to use
      global event recording and the impacted users have been notified.

  subject: &subject "CloudTrail Logs - Global Event Recording Has Been Enabled - [custodian {{ account }} - {{ region }}]"

  mailer-queue: &mailer-queue https://sqs.{region}.amazonaws.com/{account}/cloud-custodian-mailer





policies:


#############################################################################
#####   AWS.CLOUDTRAIL - Enable Global Event Recording                  #####
#############################################################################




#########################
## CloudTrail mode policy
#########################


- name: aws-cloudtrail-global-events
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Compliance::PCI DSS
    - Risk::High
  resource: cloudtrail
  metadata:
    long-description: *long-description
  mode:
      type: cloudtrail
      events:
        - source: cloudtrail.amazonaws.com
          event: UpdateTrail
          ids: 'responseElements.trailARN'
        - source: cloudtrail.amazonaws.com
          event: PutEventSelectors
          ids: 'responseElements.trailARN'
  description: *description
  filters:
      - IncludeGlobalServiceEvents: false
  actions:
      - type: update-trail
        attributes:
          IncludeGlobalServiceEvents: true
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        violation_desc: *violation-desc
        action_desc: *action-desc
        owner_absent_contact:
            - "{missingcontact}"
        to:
            - resource-owner
            - event-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}




####################
## Pull mode policy
####################


- name: aws-cloudtrail-global-events-pull
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Compliance::PCI DSS
    - Risk::High
  resource: cloudtrail
  metadata:
    long-description: *long-description
  description: *description
  filters:
      - IncludeGlobalServiceEvents: false
  actions:
      - type: update-trail
        attributes:
          IncludeGlobalServiceEvents: true
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        violation_desc: *violation-desc
        action_desc: *action-desc
        owner_absent_contact:
            - "{missingcontact}"
        to:
            - resource-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}

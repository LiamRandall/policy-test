vars:

  long-description: &long-description |
      This policy will verify that AWS Elasticsearch domains are encrypted at
      rest using customer managed KMS keys to ensure proper data security and
      compliance standards are being met. Using customer managed KMS keys
      provides finer grained security controls over the encryption and
      decryption processes versus using the AWS managed KMS keys. This policy
      helps with compliance standards such as APRA, GDPR, MAS, and NIST 800-53
      rev4 by identifying the non-compliant Elasticsearch domains which are
      either not encrypted, or encrypted with the default AWS managed KMS key,
      and taking an appropriate action. Remediation options include deletion of
      the non-encrypted domain and a notification sent to the resource creator.
      Encryption cannot be enabled after an Elasticsearch domain is created.

  description-delete: &description-delete |
      Newly launched Elasticsearch domains which are either not encrypted at
      rest or encrypted with the default AWS managed KMS key will be identified
      and tagged for deletion. Deletion will occur after domain creation is
      complete. Encryption cannot be enabled or modified after an Elasticsearch
      domain is created.

  description-notify: &description-notify |
      Elasticsearch domains which are either not encrypted or encrypted at rest
      with the default AWS managed KMS key will be identified and a notification
      sent. Encryption cannot be enabled or modified after an Elasticsearch
      domain is created. The non-compliant domain should be deleted and
      recreated using a customer managed KMS key for encryption to ensure it
      meets encryption requirements for compliance regulations.

  subject-delete: &subject-delete "Elasticsearch - Domain Deleted Due To Encryption Issue - [custodian {{ account }} - {{ region }}]"

  subject-notify: &subject-notify "Elasticsearch - Domain Encryption Issue Identified - [custodian {{ account }} - {{ region }}]"

  mailer-queue: &mailer-queue https://sqs.{region}.amazonaws.com/{account}/cloud-custodian-mailer




policies:


#################################################################################################
#####   AWS.ELASTICSEARCH - Domains Must Be Encrypted Using KMS Customer Managed CMKs       #####
#################################################################################################

## Policy Explanation:
## Elasticsearch domains must be encrypted at creation as it cannot be enabled
## afterwards. Elasticsearch domains cannot be deleted while they are in a
## creating status so a policy chain is required for remediation.


################################
## CloudTrail mode policy chain
################################


- name: aws-elasticsearch-non-cmk-encrypted
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Risk::High
  resource: elasticsearch
  metadata:
    long-description: *long-description
  mode:
    type: cloudtrail
    events:
      - CreateElasticsearchDomain
  description: *description-delete
  filters:
    - or:
      - type: value
        key: "EncryptionAtRestOptions.Enabled"
        value: false
      - type: kms-key
        key: c7n:AliasName
        value: "^(alias/aws/es)"
        op: regex
  actions:
      - type: tag
        key: EncryptionCMKCompliance





- name: aws-elasticsearch-non-cmk-encrypted-delete
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Risk::High
  resource: elasticsearch
  metadata:
    long-description: *long-description
  mode:
    type: periodic
    schedule: "rate(30 minutes)"
  description: *description-delete
  filters:
    - "tag:EncryptionCMKCompliance": present
    - Created: true
    - Processing: false
    - UpgradeProcessing: false
  actions:
    - delete
    - type: notify
      template: default.html
      priority_header: 1
      subject: *subject-delete
      to:
         - resource-owner
      transport:
           type: sqs
           queue: *mailer-queue
           region: {region}




####################
## Pull mode policy
####################


- name: aws-elasticsearch-non-cmk-encrypted-notify-pull
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Risk::High
  resource: elasticsearch
  metadata:
    long-description: *long-description
  description: *description-notify
  filters:
    - or:
      - type: value
        key: "EncryptionAtRestOptions.Enabled"
        value: false
      - type: kms-key
        key: c7n:AliasName
        value: "^(alias/aws/es)"
        op: regex
  actions:
    - type: tag
      key: EncryptionCMKComplianceNotify
    - type: notify
      template: default.html
      priority_header: 1
      subject: *subject-notify
      to:
        - resource-owner
      transport:
        type: sqs
        queue: *mailer-queue
        region: {region}

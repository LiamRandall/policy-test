vars:

  long-description: &long-description |
      These policies will check to verify that there is at least one IAM user
      setup in each account with a canary access key. Having a canary access key
      present in each account provides a proactive security measure in the form
      of deception technology via security traps. The canary IAM user access key
      should have very little to no permissions attached and should be monitored
      for any usage as it may indicate an attacker credential breach. This policy helps
      with compliance standard NIST 800-53 rev4 by identifying the accounts
      which are either missing a canary IAM user access key and by identifying
      canary access key usage.

  description: &description |
      Any account which is either missing or has a invalid configured AWS IAM
      IDP will be identified, and the impacted users notified.

  description-breach: &description-breach |
      The identified AWS IAM canary users have recent activity which should be
      investigated as this could indicate unauthorized access or a breach of
      credentials.

  subject: &subject "IAM User - Missing Canary IAM User [custodian {{ account }} - {{ region }}]"

  subject-breach: &subject-breach "IAM User - Breached Canary Access Keys Used! [custodian {{ account }} - {{ region }}]"

  violation-desc: &violation-desc |
      The identified AWS accounts do not have an IAM canary user setup. Canary
      IAM users are good to have setup as they provide security traps and make
      attackers announce themselves when they try to use the users credentials.

  action-desc: &action-desc |
      You can setup a IAM canary user by creating a new user account with 1
      access key, no console password, and no permissions attached.

  violation-desc-breach: &violation-desc-breach |
      A security breach may have occurred! The identified canary access key has
      been used in the last weeks time and should be investigated immediately.

  action-desc-breach: &action-desc-breach |
      Please investigate the attempted usage of the identified IAM users canary
      access key as this may indicate a security breach. The identified canary
      user should have no permissions to perform any actions within AWS but
      access key usage has been detected.


  mailer-queue: &mailer-queue https://sqs.{region}.amazonaws.com/{account}/cloud-custodian-mailer




policies:




####################
## Pull mode policy
####################


- name: aws-account-missing-iam-user-canary-access-key-pull
  tags:
    - Category::Security
    - Compliance::NIST
    - Risk::High
  metadata:
    long-description: *long-description
  resource: account
  description: *description
  filters:
     - type: missing
       policy:
         resource: iam-user
         filters:
          - type: access-key
            key: Status
            value: Active
          - type: check-permissions
            match: denied
            actions:
              - '*:*'
          - type: credential
            key: password_enabled
            value: false
  actions:
    - type: notify
      template: default.html
      priority_header: 1
      subject: *subject
      violation_desc: *violation-desc
      action_desc: *action-desc
      to:
        - resource-owner
      transport:
          type: sqs
          queue: *mailer-queue
          region: {region}



- name: aws-iam-user-canary-access-key-breach-pull
  tags:
    - Category::Security
    - Compliance::NIST
    - Risk::High
  metadata:
    long-description: *long-description
  resource: iam-user
  description: *description-breach
  filters:
      - type: access-key
        key: Status
        value: Active
      - type: check-permissions
        match: denied
        actions:
          - '*:*'
      - type: credential
        key: password_enabled
        value: false
      - type: credential
        key: access_keys.last_used_date
        value_type: age
        value: 7
        op: less-than
  actions:
    - type: notify
      template: default.html
      priority_header: 1
      subject: *subject-breach
      violation_desc: *violation-desc-breach
      action_desc: *action-desc-breach
      to:
        - resource-owner
      transport:
          type: sqs
          queue: *mailer-queue
          region: {region}

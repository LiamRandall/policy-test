vars:

  long-description: &long-description |
      When you use your own AWS KMS Customer Master Keys (CMKs) to protect the
      backups created with the AWS Backup service, you have full control over
      who can use the encryption keys to access your backups. AWS Key Management
      Service (KMS) allows you to easily create, rotate, disable and audit the
      Customer Master Keys used to encrypt AWS Backup data.

  description: &description |
      This policy ensures that your AWS Backup vault are using AWS KMS Customer
      Master Keys instead of AWS managed-keys for encrypting your backup data,
      in order to have fine-grained control over your data-at-rest encryption
      processes, while also helping you to meet various compliance requirements.

  violation-desc: &violation-desc |
      The AWS Backup vault was not configured to to use AWS KMS Customer Master
      Keys to encrypt its vault, which is a best practice. You should consider
      recreating the Backup Vault using a KMS Customer Master Key (CMK) and
      associating your backup jobs with the new Vault.

  action-desc: &action-desc |
      The AWS Backup vault was not configured to to use AWS KMS Customer Master
      Keys to encrypt its vault, which is a best practice.

  subject: &subject "AWS Backup Vault - Encryption Issue Identified - [custodian {{ account }} - {{ region }}]"

  mailer-queue: &mailer-queue https://sqs.{region}.amazonaws.com/{account}/cloud-custodian-mailer



policies:


##########################################################################
#####   AWS.BACKUP VAULT NOT ENCRYPTED W AWS CMK                     #####
##########################################################################



################################
## CloudTrail mode policy     ##
################################


- name: aws-backup-vault-encrypted-cmk
  tags:
    - Category::Security
    - Compliance::CIS Security AWS Foundations Benchmark
    - Risk::High
  metadata:
      long-description: *long-description
  mode:
    type: cloudtrail
    events:
        - source: backup.amazonaws.com
          event: CreateBackupVault
          ids: "responseElements.backupVaultName"
  resource: aws.backup-vault
  filters:
    - type: kms-key
      key: c7n:AliasName
      value: alias/aws/backup
  actions:
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        violation_desc: *violation-desc
        action_desc: *action-desc
        to:
            - resource-owner
            - event-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}




################################
## Pull mode policy           ##
################################


- name: aws-backup-vault-encrypted-cmk-pull
  tags:
    - Category::Security
    - Compliance::CIS Security AWS Foundations Benchmark
    - Compliance::PCI-DSS
    - Compliance::HIPAA
    - Compliance::GDPR
    - Compliance::APRA
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Risk::High
  metadata:
      long-description: *long-description
  resource: aws.backup-vault
  filters:
    - type: kms-key
      key: c7n:AliasName
      value: alias/aws/backup
  actions:
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        violation_desc: *violation-desc
        action_desc: *action-desc
        to:
            - resource-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}

vars:

  long-description: &long-description |
      This policy will verify that S3 buckets are using encryption so that
      sensitive data is secure at rest. Many regulatory and compliance standards
      require data encryption to be enabled across resources. If any S3 buckets
      are found without encryption, the default server side encryption will be
      enabled and a notification sent. This policy helps with compliance
      standards such as APRA, GDPR, HIPAA, MAS, NIST 800-53 rev4 and PCI DSS by
      identifying and remediating the non-compliant S3 buckets.

  description: &description |
      S3 buckets which are not utilizing Server Side Encryption (SSE) will be
      identified, modified to use the aws/s3 KMS key, and the impacted users
      will be notified.

  violation-desc: &violation-desc |
      S3 buckets should be using Server Side Encryption (SSE) for secure data at
      rest. The identified S3 buckets were not using SSE and have now been modified
      to utilize SSE with the aws/s3 KMS key.

  action-desc: &action-desc |
      The identified S3 buckets are now being encrypted with the default aws/s3 KMS
      key. Please ensure your S3 buckets still function properly as any
      interactions with encrypted S3 buckets will require the client to have KMS
      Decrypt permissions.

  subject: &subject "S3 Bucket - Default Encryption Has Been Enabled - [custodian {{ account }} - {{ region }}]"

  mailer-queue: &mailer-queue https://sqs.{region}.amazonaws.com/{account}/cloud-custodian-mailer





policies:


####################################################################
#####   AWS.S3 - Enable SSE Bucket Encryption                  #####
####################################################################




#########################
## CloudTrail mode policy
#########################


- name: aws-s3-enable-encryption
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::HIPAA
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Compliance::PCI DSS
    - Risk::High
  resource: s3
  metadata:
    long-description: *long-description
  mode:
      type: cloudtrail
      events:
        - CreateBucket
        - source: 's3.amazonaws.com'
          event: DeleteBucketEncryption
          ids: "requestParameters.bucketName"
  description: *description
  filters:
      - type: bucket-encryption
        state: False
  actions:
      - type: set-bucket-encryption
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        violation_desc: *violation-desc
        action_desc: *action-desc
        owner_absent_contact:
            - "{missingcontact}"
        to:
            - resource-owner
            - event-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}




####################
## Pull mode policy
####################


- name: aws-s3-enable-encryption-pull
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::HIPAA
    - Compliance::MAS
    - Compliance::NIST 800-53
    - Compliance::PCI DSS
    - Risk::High
  resource: s3
  max-resources:
    percent: 10
    amount: 10
    op: and
  metadata:
    long-description: *long-description
  description: *description
  filters:
      - type: bucket-encryption
        state: False
  actions:
      - type: set-bucket-encryption
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        violation_desc: *violation-desc
        action_desc: *action-desc
        owner_absent_contact:
            - "{missingcontact}"
        to:
            - resource-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}

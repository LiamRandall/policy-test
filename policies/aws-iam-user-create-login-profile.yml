vars:


  long-description: &long-description |
      This policy will identify when an IAM User is being granted a console
      access password via the CreateLoginProfile API call. The policy will then
      remediate the console access permissions by removing them, followed by an
      email notification to the impacted users. If console access is required
      for a user, the permissions will need to be granted by an approved and
      whitelisted IAM User account. This policy helps prevent users and
      attackers from elevating their own or other user's access which they could
      use to compromise an account.

  description: &description |
      IAM User access should only be granted by an approved and whitelisted IAM
      administrator user account. The console password has been removed for the
      identified user as it was not granted through an approved user.

  subject: &subject "IAM User - Console Password Has Been Removed! [custodian {{ account }} - {{ region }}]"

  mailer-queue: &mailer-queue https://sqs.{region}.amazonaws.com/{account}/cloud-custodian-mailer




policies:

####################################################################
#####   AWS.IAM-USER - CreateLoginProfile Event Detected       #####
####################################################################



#########################
## CloudTrail mode policy
#########################


- name: aws-iam-user-create-login-profile
  metadata:
      long-description: *long-description
  resource: iam-user
  description: *description
  region: us-east-1
  mode:
     type: cloudtrail
     events:
        - source: iam.amazonaws.com
          event: CreateLoginProfile
          ids: "requestParameters.userName"
  filters:
      - type: value
        key: UserName
        op: not-in
        value:
          - approved-username-1
          - approved-username-2
  actions:
      - type: delete
        options:
          - console-access
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        to:
            - event-owner
            - resource-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}

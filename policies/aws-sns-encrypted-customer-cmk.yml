vars:

  long-description: &long-description |
      This policy will ensure SNS topics are encrypted and using customer
      managed CMK KMS Keys. Using customer managed CMK KMS keys provides full
      control over who can use the keys to access data encrypted with them. This
      policy helps with compliance standards such as GDPR, APRA, MAS, and NIST
      800-53 rev4 by identifying the non-compliant sns topics.

  description: &description |
      SNS topics which are not encrypted with a customer owned CMK KMS key will
      be identified, encrypted, and the impacted users will be notified.

  violation-desc: &violation-desc |
      SNS topics should be encrypted and the encryption key used should be a
      customer managed CMK key. The identified topics either had encryption disabled
      or were encrypted using an AWS managed CMK key which does not meet
      compliance standards.

  action-desc: &action-desc |
      The identified SNS topics have been updated to be encrypted using the company's
      customer managed CMK key of alias/Company-Standardized-SNS-CMK. Please
      verify your topics functionality as the enabling of encryption or
      switching of encryption keys can affect some client's connectivity.

  subject: &subject "SNS Topic - Encryption Has Been Enabled/Updated - [custodian {{ account }} - {{ region }}]"

  mailer-queue: &mailer-queue https://sqs.{region}.amazonaws.com/{account}/cloud-custodian-mailer




policies:


##########################################################################
#####   AWS.SNS - Not Encrypted With Customer Managed CMK KMS  Key   #####
##########################################################################




#########################
## CloudTrail mode policy
#########################


- name: aws-sns-not-encrypted-with-customer-cmk
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::NIST
    - Compliance::MAS
    - Risk::High
  metadata:
    long-description: *long-description
  resource: sns
  mode:
      type: cloudtrail
      events:
        - source: sns.amazonaws.com
          event: CreateTopic
          ids: 'responseElements.topicArn'
        - source: sns.amazonaws.com
          event: SetTopicAttributes
          ids: 'requestParameters.topicArn'
        - source: sns.amazonaws.com
          event: AddPermission
          ids: 'requestParameters.topicArn'
  description: *description
  filters:
   - or:
      - "KmsMasterKeyId": absent
      - type: kms-key
        key: c7n:AliasName
        value: ^alias\/aws\/.+
        op: regex
  actions:
      - type: set-encryption
        key: alias/Company-Standardized-SNS-CMK
        enabled: true
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        violation_desc: *violation-desc
        action_desc: *action-desc
        owner_absent_contact:
            - "{missingcontact}"
        to:
            - resource-owner
            - event-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}




####################
## Pull mode policy
####################


- name: aws-sns-not-encrypted-with-customer-cmk-pull
  tags:
    - Category::Security
    - Compliance::APRA
    - Compliance::GDPR
    - Compliance::NIST
    - Compliance::MAS
    - Risk::High
  metadata:
    long-description: *long-description
  resource: sns
  max-resources:
    percent: 10
    amount: 10
    op: and
  description: *description
  filters:
   - or:
      - "KmsMasterKeyId": absent
      - type: kms-key
        key: c7n:AliasName
        value: ^alias\/aws\/.+
        op: regex
  actions:
      - type: set-encryption
        key: alias/Company-Standardized-SNS-CMK
        enabled: true
      - type: notify
        template: default.html
        priority_header: 1
        subject: *subject
        violation_desc: *violation-desc
        action_desc: *action-desc
        owner_absent_contact:
            - "{missingcontact}"
        to:
            - resource-owner
        transport:
            type: sqs
            queue: *mailer-queue
            region: {region}
